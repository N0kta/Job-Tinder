<!DOCTYPE html>
<html>
<head>
  <title>Callback</title>
</head>
<body>
  <h1>Processing login...</h1>
    <button id="protect">call api</button>
    <script>
        const code = new URLSearchParams(window.location.search).get("code");
        console.log("Authorization code:", code);

        const app_url = "https://jobtinder.local"
        const keycloak_url="https://jobtinder.local/keycloak"
        const redirect_uri=app_url+"/auth/callback"
        const client_id="jobtinder-app"



        async function handleCallback() {
            const existingToken = localStorage.getItem("access_token");
            if (existingToken != "undefined") return; // Already have tokens, no need to exchange code again

            const params = new URLSearchParams(window.location.search);
            const code = params.get("code");
            const verifier = localStorage.getItem("pkce_verifier");

            if (!code) return;

            // Exchange code for tokens directly with Keycloak
            const response = await fetch(keycloak_url+"/realms/FastAPI/protocol/openid-connect/token", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({
                grant_type: "authorization_code",
                client_id: client_id,
                code: code,
                redirect_uri: redirect_uri,
                code_verifier: verifier,
                })
            });

            const tokens = await response.json();
            console.log("Got tokens:", tokens);

            // Store tokens in memory or cookie
            localStorage.setItem("access_token", tokens.access_token);
            localStorage.setItem("refresh_token", tokens.refresh_token);
        }

        async function refreshToken() {
            const refresh_token = localStorage.getItem("refresh_token");
            if (!refresh_token) return null;

            const response = await fetch(keycloak_url + "/keycloak/realms/FastAPI/protocol/openid-connect/token", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({
                grant_type: "refresh_token",
                client_id: client_id,
                refresh_token: refresh_token,
                }),
            });

            if (!response.ok) {
                console.error("Refresh failed");
                return null;
            }

            const tokens = await response.json();
            localStorage.setItem("access_token", tokens.access_token);
            localStorage.setItem("refresh_token", tokens.refresh_token);
            return tokens.access_token;
        }


        handleCallback()

        async function fetchProtected() {
            const token = localStorage.getItem("access_token");

            const response = await fetch(app_url+"/protected", {
            headers: { Authorization: `Bearer ${token}` }
            });

            const data = await response.json();
            console.log("Protected data:", data);
        }

        document.getElementById("protect").onclick = () => {
            fetchProtected()
        }

    </script>
</body>
</html>
