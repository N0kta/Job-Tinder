<!DOCTYPE html>
<html>
<head>
  <title>JobTinder Login</title>
</head>
<body>
  <h1>JobTinder</h1>
  <button id="loginBtn">Login with Keycloak</button>

  <script>
    const realm = "FastAPI";
    const client_id = "jobtinder-app";
    const keycloakUrl = "https://jobtinder.local/keycloak";
    const redirect_uri="https://jobtinder.local/auth/callback"

    function generateRandomString(length) {
        const array = new Uint32Array(length);
        window.crypto.getRandomValues(array);
        return Array.from(array, dec => ("0" + dec.toString(16)).slice(-2)).join("");
    }

    async function sha256(plain) {
        const encoder = new TextEncoder();
        const data = encoder.encode(plain);
        const hash = await window.crypto.subtle.digest("SHA-256", data);
        return btoa(String.fromCharCode(...new Uint8Array(hash)))
            .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }

    async function createPKCECodes() {
        const verifier = generateRandomString(64);
        const challenge = await sha256(verifier);
        localStorage.setItem("pkce_verifier", verifier);
        return challenge;
    }

    async function redirectToLogin() {
        const challenge = await createPKCECodes();
        const url = keycloakUrl+`/realms/FastAPI/protocol/openid-connect/auth` +
            `?client_id=${client_id}` +
            `&response_type=code` +
            `&scope=openid` +
            `&redirect_uri=${redirect_uri}` +
            `&code_challenge=${challenge}` +
            `&code_challenge_method=S256`;

        window.location.href = url;
    }

    document.getElementById("loginBtn").onclick = () => {
        redirectToLogin()
    }
  </script>
</body>
</html>
